name: Deploy to Apache GUEST

on:
  workflow_dispatch:
  push:
    branches: [ master ]

permissions:
  contents: read

concurrency:
  group: deploy-guest-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy-guest:
    name: Deploy to Apache GUEST
    runs-on: self-hosted
    env:
      DEPLOY_PATH: /var/www/html/GUEST

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install production dependencies
        run: |
          echo "Installing deps (locked)..."
          composer install --no-dev --prefer-dist --no-interaction --optimize-autoloader

      - name: Run database migrations
        run: |
          echo "Running migrations..."
          php vendor/bin/phinx migrate -e production

      - name: Sync files to Apache GUEST directory
        env:
          APACHE_USER: www-data
        run: |
          mkdir -p "$DEPLOY_PATH"
          sudo rsync -rltD --delete --chown="$APACHE_USER:$APACHE_USER" \
            --chmod=Du=rwx,Dg=rx,Da=rx,Fu=rw,Fg=r,Fa=r \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='docs' \
            --exclude='tests' \
            --exclude='logs' \
            ./ "$DEPLOY_PATH"/

      - name: Verify deployment contents
        run: |
          echo "Deployment complete. Listing target directory:"
          ls -la "$DEPLOY_PATH" | head
